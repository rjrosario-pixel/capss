<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TERRAPhish - Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>

<header>
  <div class="left-section">
    <div class="logo">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
      <button id="hamburger" class="menu-toggle" title="Menu">☰</button>
    </div>
  </div>

  <nav id="main-nav" class="nav-links">
    <a href="{{ url_for('scanner') }}" id="nav-scanner">URL and Domain Scanner</a>
    <a href="{{ url_for('block_page') }}" id="nav-blocking">Blocking</a>
    <a href="{{ url_for('dashboard') }}" id="nav-dashboard" class="active">Dashboard</a>
  </nav>

  <div class="profile">
  <nav class="notification-nav">
    {% if current_user.is_authenticated %}
      <!-- Bell only when logged in -->
      <span class="bell" id="notif-bell" title="Notifications">
        <img src="{{ url_for('static', filename='notif_icon.png') }}" alt="Notifications">
        <span class="notif-badge" id="notif-count" style="display: none;">0</span>
      </span>
    {% endif %}
  </nav>

    {% if user %}
      <span id="nav-user">{{ user.username }}</span>
    {% else %}
      <span id="nav-user">Guest</span>
    {% endif %}

    <div class="dropdown">
      <button id="menu-btn" class="menu-btn" title="Menu">⋮</button>
      <div class="dropdown-content" id="dropdown-menu">
        <form method="POST" action="{{ url_for('logout') }}">
          <button type="submit">Log Out</button>
        </form>
      </div>
    </div>
  </div>
</header>

<div class="notification-panel" id="notification-panel" style="display: none;">
  <div class="panel-header">
    <h4>Notifications</h4>
    <button id="clear-notifications">Clear All</button>
  </div>
  <div class="panel-body" id="notification-list"></div>
</div>

<main class="container">
  <h1>Dashboard</h1>
  <div class="status-cards">
    <div class="card green">
      <p>Activity</p>
      <h2 id="scan-count">{{ scan_count }}</h2>
      <p>You scanned {{ scan_count }} websites today</p>
    </div>
    <div class="card red">
      <p>Blocked Threats</p>
      <h2 id="block-count">{{ block_count }}</h2>
      <p>{{ block_count }} phishing URLs/Domains were blocked today</p>
    </div>
    <div class="card yellow" id="alert-card">
      <p>Alerts</p>
      <h2 id="alert-status">Loading...</h2>
      <p id="alert-message">Fetching your latest result...</p>
    </div>

    <div class="card gray">
      <p>Blacklist Updates</p>
      <h2>Up to Date</h2>
      <p>Your phishing blacklist is updated</p>
    </div>
  </div>

  <section class="stats">
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <h2>Phishing URLs and Domains Blocked</h2>
      <div class="filters" style="display:flex; gap:10px; flex-wrap:wrap;">
        <label for="yearFilter">Show:</label>
<select id="yearFilter">
  <option value="7d" selected>Last 7 Days</option>
  <option value="1m">Last 1 Month</option>
  <option value="1y">Last 1 Year</option>
</select>
      </div>
    </div>
    <!-- Chart container -->
<div id="chartWrapper" style="overflow-x:auto; white-space:nowrap; padding-bottom:10px; height: 300px;">
  <div id="chartInner" style="min-width:300px; height:100%;"> <!-- ✅ inner wrapper full height -->
    <canvas id="blockedChart" style="height:100% !important; max-height:100% !important;"></canvas>
  </div>
</div>

  </section>
<br>
  <!-- Scan History Section -->
  <section class="history">
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <h2>Scan History</h2>
      <div class="filters" style="display:flex; gap:10px; flex-wrap:wrap;">
        <label for="history-period"></label>
        <select id="history-period">
          <option value="7d">Last 7 Days</option>
          <option value="1m">Last 1 Month</option>
          <option value="1y">Last 1 Year</option>
        </select>
        <button id="clear-history-btn" class="btn-red">Clear History</button>
      </div>
    </div>

    <div class="table-container">
      <table class="responsive-table">
        <thead>
          <tr>
            <th>Source URL</th>
            <th>Domain</th>
            <th>IP Address</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% if history %}
            {% for row in history %}
            <tr>
              <td>{{ row.url }}</td>
              <td>{{ row.domain or "-" }}</td>
              <td>{{ row.ip_address or "-" }}</td>
              <td>
                <span class="status status-{{ row.result|lower|replace(' ', '-') }}">
                  {{ row.result.capitalize() if row.result else "Unknown" }}
                </span>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4">No scan history available.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const menuBtn = document.getElementById("menu-btn");
  const dropdown = document.getElementById("dropdown-menu");
  const hamburger = document.getElementById("hamburger");
  const nav = document.getElementById("main-nav");

  /* ----- Menu & Hamburger ----- */
  window.addEventListener("click", function (e) {
    if (!menuBtn.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = "none";
    }
  });

  menuBtn.addEventListener("click", function () {
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
  });

  hamburger.addEventListener("click", function () {
    nav.classList.toggle("visible");
  });

  /* ----- Time-ago formatting ----- */
  function getTimeAgo(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHr = Math.floor(diffMin / 60);
    const diffDays = Math.floor(diffHr / 24);

    const formatTime = (date) => {
      let hours = date.getHours();
      let minutes = date.getMinutes();
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? "0" + minutes : minutes;
      return `${hours}:${minutes} ${ampm}`;
    };

    const formatFullDate = (date) => {
      return date.toLocaleString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      });
    };

    if (diffSec < 60) return "just now";
    if (diffMin < 60) return `${diffMin} minute${diffMin !== 1 ? "s" : ""} ago`;
    if (diffHr < 24) return `${diffHr} hour${diffHr !== 1 ? "s" : ""} ago`;
    if (diffDays === 1) return `Yesterday, ${formatTime(then)}`;
    if (diffDays < 7) return `${diffDays} days ago, ${formatTime(then)}`;
    return formatFullDate(then);
  }

  function updateTimes() {
    document.querySelectorAll(".time-ago").forEach(el => {
      const ts = el.getAttribute("data-timestamp");
      if (ts) el.textContent = getTimeAgo(ts);
    });
  }
  updateTimes();
  setInterval(updateTimes, 30000);

  /* ----- NOTIFICATIONS – EXACT SAME AS scanner.html ----- */
  function updateNotificationsUI(showPanelTemporarily = false) {
    const panel = document.getElementById("notification-panel");
    const list = document.getElementById("notification-list");
    const badge = document.getElementById("notif-count");

    fetch('/get_notifications')
      .then(res => res.json())
      .then(data => {
        list.innerHTML = "";

        if (data.length > 0) {
          badge.style.display = "inline-block";
          badge.textContent = data.length;
          if (showPanelTemporarily) {
            panel.style.display = "block";
            setTimeout(() => { panel.style.display = "none"; }, 3000);
          }
        } else {
          badge.style.display = "none";
          panel.style.display = "none";
        }

        data.slice().reverse().forEach(note => {
          const item = document.createElement("div");
          item.className = "notification-item";

          const scannedUrl = note.url ? note.url : "URL not available";

          // --- Special case: Safe to Phish ---
          const isSafeToPhish = /was\s+Safe\s+before/i.test(note.message) &&
                                /flagged\s+as\s+Phish/i.test(note.message);

          let icon = "INFO";
          let title = "Info";
          let desc = note.message;
          let urlDiv = `<div class="notif-url">${scannedUrl}</div>`;

          if (isSafeToPhish) {
            icon = "⚠️ ALERT";
            title = "ALERT";
            desc = `The URL <strong style="color:red;">${scannedUrl}</strong> was <strong>Safe</strong> before but is now flagged as <strong>Phish</strong>.`;
            urlDiv = "";
          } else if (note.message.includes("Result: Safe")) {
            icon = "✅ SAFE";
            title = "Safe";
            desc = "This site appears to be safe and no threats were detected.";
          } else if (note.message.startsWith("SAFE:")) {
            icon = "✅ SAFE";
            title = "Safe";
            desc = note.message.substring(6);
          } else if (note.message.startsWith("ALERT:")) {
            icon = "⚠️ ALERT";
            title = "ALERT";
            desc = note.message.substring(7);
          } else if (note.message.includes("manually blocked")) {
            icon = "⛔ BLOCKED";
            title = "Blocked URL";
            desc = "This URL has been manually blocked and is inaccessible.";
          } else if (note.message.startsWith("INFO:")) {
            icon = "ℹ️ INFO";
            title = "Info";
            desc = note.message.substring(6);
          }

          item.innerHTML = `
            <div class="notif-header">
              <span class="notif-icon">${icon}</span>
              <span class="time-ago" data-timestamp="${note.timestamp}">${getTimeAgo(note.timestamp)}</span>
            </div>
            ${urlDiv}
            <p><strong>${title}</strong><br>${desc}</p>
          `;

          list.prepend(item);
        });

        // Update alert card with latest notification
        if (data.length > 0) {
          updateAlertCard(data[0]);
        } else {
          updateAlertCard(null);
        }

        requestAnimationFrame(() => updateTimes());
      })
      .catch(err => console.error("Failed to load notifications:", err));
  }

  // Keep your existing updateAlertCard function (unchanged)
  function updateAlertCard(latestNote) {
  const alertStatus = document.getElementById("alert-status");
  const alertMessage = document.getElementById("alert-message");
  const alertCard = document.getElementById("alert-card");

  if (!latestNote) {
    alertStatus.textContent = "No Scans";
    alertMessage.textContent = "Scan a URL to see results here.";
    alertCard.className = "card yellow";
    return;
  }

  const msg = latestNote.message.toUpperCase(); // Normalize

  if (msg.includes("SAFE")) {
    alertStatus.textContent = "SAFE";
    alertMessage.textContent = "The recent scan is Safe.";
    alertCard.className = "card green";
  }
  else if (msg.includes("PHISH") || msg.includes("ALERT")) {
    alertStatus.textContent = "PHISH";
    alertMessage.textContent = "The recent scan is Phish.";
    alertCard.className = "card red";
  }
  else if (msg.includes("BLOCKED")) {
    alertStatus.textContent = "BLOCKED";
    alertMessage.textContent = "A URL was manually blocked.";
    alertCard.className = "card gray";
  }
  else {
    alertStatus.textContent = "INFO";
    alertMessage.textContent = "Check notifications for details.";
    alertCard.className = "card yellow";
  }
}

  document.addEventListener("DOMContentLoaded", () => {
    const bell = document.getElementById("notif-bell");
    const panel = document.getElementById("notification-panel");
    const clearBtn = document.getElementById("clear-notifications");

    if (bell) {
      bell.addEventListener("click", (e) => {
        e.stopPropagation();
        panel.style.display = panel.style.display === "block" ? "none" : "block";
        if (panel.style.display === "block") updateTimes();
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        fetch('/clear_notifications', { method: 'POST' })
          .then(() => {
            panel.style.display = "none";
            document.getElementById("notif-count").style.display = "none";
            document.getElementById("notification-list").innerHTML = "";
            updateAlertCard(null);
          });
      });
    }

    document.addEventListener("click", (e) => {
      if (!panel.contains(e.target) && e.target !== bell && !bell?.contains(e.target)) {
        panel.style.display = "none";
      }
    });

    updateNotificationsUI(false);
  });

  /* ----- Socket.IO – Flash panel on scan complete ----- */
  (function(){
    const socket = io({ path: '/socket.io' });

    socket.emit("join", { 
      user_id: "{{ current_user.id if current_user.is_authenticated else 'guest' }}" 
    });

    socket.on("joined", data => console.log("Joined room:", data.room));

    socket.on("scan_progress", (data) => {
      if (data.progress === 100 && data.result) {
        updateNotificationsUI(true);  // Show panel for 3s
      }
    });
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let blockedChart;

async function loadChart(period="7d") {  // default is 7 days
  const res = await fetch(`/api/chart-data/${period}`);
  const { labels, data } = await res.json();

  const ctx = document.getElementById('blockedChart').getContext('2d');

  const chartInner = document.getElementById("chartInner");
  chartInner.style.minWidth = labels.length > 15 ? (labels.length * 60) + "px" : "900px";

  if (blockedChart) blockedChart.destroy();

  blockedChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Blocked URLs',
        data: data,
        borderColor: '#004ed4',                     // main line color
        backgroundColor: 'rgba(55, 129, 255, 0.3)', // soft fill under line
        fill: true,
        tension: 0.3,
        pointRadius: 4,
        pointBackgroundColor: '#003b9f',            // darker point color
        pointBorderColor: '#ffffff',
        pointHoverRadius: 6,
        pointHoverBackgroundColor: '#0057ec'        // brighter hover color
      }]

    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { autoSkip: false } },
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

// ✅ Load default chart (last 7 days)
loadChart();

// Change filter dynamically
document.getElementById('yearFilter').addEventListener('change', e => {
  loadChart(e.target.value);
});
</script>

<script>
document.getElementById("history-period").addEventListener("change", async (e) => {
  const filter = e.target.value;
  const tbody = document.querySelector(".responsive-table tbody");

  try {
    const res = await fetch(`/api/scan-history?filter=${filter}`);
    const data = await res.json();
    tbody.innerHTML = "";

    if (data.history.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4">No scan history available.</td></tr>`;
      return;
    }

    data.history.forEach(row => {
      // Normalize result for CSS class: "Safe" → "safe", "Phish" → "phish", etc.
      const resultKey = row.result.toLowerCase().replace(/\s+/g, '-'); // handles "High Risk" → "high-risk"
      const displayText = row.result;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.url || "-"}</td>
        <td>${row.domain || "-"}</td>
        <td>${row.ip_address || "-"}</td>
        <td>
          <span class="status status-${resultKey}">
            ${displayText}
          </span>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Failed to fetch scan history:", err);
  }
});
</script>

<script>
document.getElementById("clear-history-btn").addEventListener("click", async () => {
  try {
    const res = await fetch("/clear_scan_history", { method: "POST" });
    const data = await res.json();

    if (data.status === "success") {
      // Just clear the table quietly
      const tbody = document.querySelector(".responsive-table tbody");
      tbody.innerHTML = `<tr><td colspan="4">No scan history available.</td></tr>`;
    } else {
      console.error("Failed to clear history:", data.message || "Unknown error");
    }
  } catch (err) {
    console.error("Error clearing scan history:", err);
  }
});
</script>



</body>
</html>
